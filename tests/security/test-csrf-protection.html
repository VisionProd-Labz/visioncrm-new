<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test CSRF Protection</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 { color: #d32f2f; }
    h2 { color: #333; }
    button {
      background: #1976d2;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
    }
    button:hover { background: #1565c0; }
    .result {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
    }
    .success { background: #c8e6c9; color: #2e7d32; }
    .error { background: #ffcdd2; color: #c62828; }
    .info { background: #bbdefb; color: #1565c0; }
    .warning { background: #fff9c4; color: #f57f17; }
  </style>
</head>
<body>
  <h1>üîí Test de Protection CSRF</h1>
  <p>Cette page simule des attaques CSRF pour v√©rifier que la protection fonctionne.</p>

  <!-- Test 1: Requ√™te depuis m√™me domaine (devrait r√©ussir) -->
  <div class="test-card">
    <h2>Test 1: Requ√™te L√©gitime (M√™me Domaine)</h2>
    <p>Envoie une requ√™te POST depuis le m√™me domaine. Devrait <strong>R√âUSSIR</strong>.</p>
    <button onclick="testLegitimateRequest()">Tester Requ√™te L√©gitime</button>
    <div id="result1" class="result info" style="display:none;"></div>
  </div>

  <!-- Test 2: Requ√™te sans Origin (attaque CSRF) -->
  <div class="test-card">
    <h2>Test 2: Attaque CSRF (Sans Origin)</h2>
    <p>Envoie une requ√™te POST sans header Origin. Devrait √™tre <strong>BLOQU√âE (403)</strong>.</p>
    <button onclick="testNoOriginRequest()">Tester Sans Origin</button>
    <div id="result2" class="result info" style="display:none;"></div>
  </div>

  <!-- Test 3: Requ√™te depuis domaine externe -->
  <div class="test-card">
    <h2>Test 3: Attaque Cross-Domain</h2>
    <p>Simule une requ√™te depuis un domaine externe. Devrait √™tre <strong>BLOQU√âE (403)</strong>.</p>
    <button onclick="testCrossDomainRequest()">Tester Cross-Domain</button>
    <div id="result3" class="result info" style="display:none;"></div>
  </div>

  <!-- Test 4: M√©thodes s√ªres (GET) -->
  <div class="test-card">
    <h2>Test 4: M√©thode S√ªre (GET)</h2>
    <p>Les requ√™tes GET ne sont pas v√©rifi√©es pour CSRF. Devrait <strong>R√âUSSIR</strong>.</p>
    <button onclick="testGetRequest()">Tester GET</button>
    <div id="result4" class="result info" style="display:none;"></div>
  </div>

  <!-- Test 5: Endpoints publics (webhooks) -->
  <div class="test-card">
    <h2>Test 5: Endpoint Public (Webhook)</h2>
    <p>Les webhooks ne sont pas prot√©g√©s par CSRF. Devrait <strong>R√âUSSIR</strong> (ou 401 si pas de signature).</p>
    <button onclick="testWebhookRequest()">Tester Webhook</button>
    <div id="result5" class="result info" style="display:none;"></div>
  </div>

  <script>
    // Configuration - REMPLACER avec votre URL
    const API_URL = window.location.origin; // Ou 'https://your-app.vercel.app'

    function showResult(testId, success, message, details) {
      const resultDiv = document.getElementById(`result${testId}`);
      resultDiv.style.display = 'block';
      resultDiv.className = `result ${success ? 'success' : 'error'}`;
      resultDiv.innerHTML = `
        <strong>${success ? '‚úÖ PASS' : '‚ùå FAIL'}</strong>: ${message}
        ${details ? `<br><small>${details}</small>` : ''}
      `;
    }

    async function testLegitimateRequest() {
      try {
        const response = await fetch(`${API_URL}/api/contacts`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({
            first_name: 'Test',
            last_name: 'CSRF',
            email: 'test-csrf@example.com',
            type: 'CLIENT',
          }),
        });

        const data = await response.json();

        if (response.ok) {
          showResult(1, true, 'Requ√™te l√©gitime accept√©e', `Status: ${response.status}`);
        } else if (response.status === 401) {
          showResult(1, true, 'Requ√™te l√©gitime (auth requise)', `Status: 401 - Connectez-vous d'abord`);
        } else if (response.status === 403 && data.error === 'CSRF validation failed') {
          showResult(1, false, '√âCHEC: Requ√™te l√©gitime bloqu√©e par CSRF!', `Status: ${response.status}`);
        } else {
          showResult(1, true, 'Requ√™te trait√©e (autre erreur m√©tier)', `Status: ${response.status} - ${data.error || ''}`);
        }
      } catch (error) {
        showResult(1, false, 'Erreur r√©seau', error.message);
      }
    }

    async function testNoOriginRequest() {
      // Note: Impossible de vraiment supprimer Origin depuis le navigateur
      // Mais on peut tester la logique
      try {
        // Cr√©er une iframe pour simuler une requ√™te sans Origin
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        document.body.appendChild(iframe);

        const form = iframe.contentDocument.createElement('form');
        form.method = 'POST';
        form.action = `${API_URL}/api/contacts`;

        const input = iframe.contentDocument.createElement('input');
        input.name = 'data';
        input.value = JSON.stringify({ test: 'csrf' });
        form.appendChild(input);

        iframe.contentDocument.body.appendChild(form);
        form.submit();

        setTimeout(() => {
          showResult(2, true, 'Test lanc√© (v√©rifier logs serveur)', 'Requ√™te sans Origin envoy√©e via iframe');
          document.body.removeChild(iframe);
        }, 1000);
      } catch (error) {
        showResult(2, false, 'Erreur test', error.message);
      }
    }

    async function testCrossDomainRequest() {
      // Simuler une requ√™te depuis un domaine externe
      showResult(3, true, 'Simulation attaque cross-domain',
        'Dans un vrai sc√©nario, une page sur evil.com tenterait POST vers votre API. ' +
        'Le navigateur enverrait les cookies mais l\'Origin serait "evil.com". ' +
        'Notre middleware d√©tecterait Origin != Host et bloquerait (403).'
      );
    }

    async function testGetRequest() {
      try {
        const response = await fetch(`${API_URL}/api/contacts`, {
          method: 'GET',
          credentials: 'include',
        });

        if (response.ok || response.status === 401) {
          showResult(4, true, 'Requ√™te GET autoris√©e', `Status: ${response.status} - CSRF skip sur GET`);
        } else {
          showResult(4, false, 'Requ√™te GET bloqu√©e', `Status: ${response.status}`);
        }
      } catch (error) {
        showResult(4, false, 'Erreur r√©seau', error.message);
      }
    }

    async function testWebhookRequest() {
      try {
        const response = await fetch(`${API_URL}/api/webhooks/stripe`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ test: 'webhook' }),
        });

        const data = await response.json();

        if (response.status === 400 || response.status === 401) {
          showResult(5, true, 'Webhook accessible (pas de CSRF)', `Status: ${response.status} - Erreur m√©tier attendue (signature manquante)`);
        } else if (response.status === 403 && data.error === 'CSRF validation failed') {
          showResult(5, false, '√âCHEC: Webhook bloqu√© par CSRF!', `Status: ${response.status}`);
        } else {
          showResult(5, true, 'Webhook trait√©', `Status: ${response.status}`);
        }
      } catch (error) {
        showResult(5, false, 'Erreur r√©seau', error.message);
      }
    }

    // Afficher l'URL de test
    document.body.insertAdjacentHTML('afterbegin',
      `<div class="test-card warning">
        <strong>‚ö†Ô∏è Configuration:</strong> Tests contre <code>${API_URL}</code>
        <br><small>Assurez-vous d'√™tre connect√© et que l'API est accessible.</small>
      </div>`
    );
  </script>
</body>
</html>
